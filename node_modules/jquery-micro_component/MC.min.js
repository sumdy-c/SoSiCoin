class MCcontext{id;key;virtualCollection;constructor(t){let{id:e,key:l}=t;this.id=e,this.key=l??null,this.virtualCollection=new Set}render(){this.virtualCollection}createVirtual_FC(t,e){let l={Fn:t,parent_id:this.id,key:e};return this.virtualCollection.add(l),[{context:this.id,id_element:e},l]}createVirtual_Component(t,e,l){let n={component:t,parent_id:this.id,key:e,identifier:l};return this.virtualCollection.add(n),[{context:this.id,id_element:e},n]}}class MCState{id;value;key;virtualCollection;passport;constructor(t,e){e&&(this.local=e);let{value:l,key:n,id:o}=t;this.value=l,this.key=n,this.id=o,this.virtualCollection=new Set}getPassport(t){this.passport=t}set(t){this.passport&&(this.value=t,this.passport.value=this.value)}get(){return this.value}}class MCEngine{state;static active=!1;constructor(){}handlerRender(t,e,l){let n={};l||(l="obj");let o=new Proxy(t,{get:(o,r)=>"object"!=typeof t[r]?t[r]:(void 0===n[r]&&(n[r]=this.handlerRender(t[r],e,`${l}.${r}`)),Reflect.get(...arguments)),set:(l,n,o)=>(e(this.state),t[n])});return o}render(t){if(0===t.virtualCollection.length)return null;MCEngine.active=!0,t.virtualCollection.forEach(t=>{if(!t.context){MC.anonimCollection.forEach(e=>{if(e.key===t.id_element){let l;if(e.component){let n=[];e.controller.global.forEach(t=>{n.push(t.value)});let o=[];e.controller.local.forEach(t=>{o.push(t.value)}),l=(l=e.component.render({global:n,local:o},e.props))?l[0]:MC_Component.createEmptyElement()}else{let r=[];e.controller.forEach(t=>{r.push(t.value)}),(l=e.Fn(r))?l.length&&(l=l[0]):l=MC_Component.createEmptyElement()}e.HTMLElement.replaceWith(l),e.HTMLElement=l}}),MCEngine.active=!1;return}MC.mc_context_global.forEach(e=>{e.id===t.context&&e.virtualCollection.forEach(e=>{if(e.key===t.id_element){let l;if(e.component){let n=[];e.controller.global.forEach(t=>{n.push(t.value)});let o=[];e.controller.local.forEach(t=>{o.push(t.value)}),l=(l=e.component.render({global:n,local:o},e.props))?l[0]:MC_Component.createEmptyElement()}else{let r=[];e.controller.forEach(t=>{r.push(t.value)}),l=(l=e.Fn(r))?l[0]:MC_Component.createEmptyElement()}e.HTMLElement.replaceWith(l),e.HTMLElement=l}})})}),MCEngine.active=!1}static renderChilds_FC(t,e){let l=null,n=!1;return t?(t.virtualCollection.forEach(t=>{if(!t.component&&t.Fn.toString()===e.toString()){n=!0;let o=[];t.controller.forEach(t=>{o.push(t.value)});let r=t.Fn(o);r=r?r[0]:MC_Component.createEmptyElement(),t.HTMLElement=r,l=t.HTMLElement}}),n)?l:"nt%Rnd#el":(MC.anonimCollection.forEach(t=>{if(!t.component&&t.Fn.toString()===e.toString()){n=!0;let o=[];t.controller.forEach(t=>{o.push(t.value)});let r=t.Fn(o);r=r?r[0]:MC_Component.createEmptyElement(),t.HTMLElement=r,l=t.HTMLElement}}),n)?l:"nt%Rnd#el"}static renderChilds_Component(t,e,l){if(!e)return console.error("[MC] Передайте при создании компонента его ключ! При отсутствии ключа, компонент может быть утерян!"),"nt%Rnd#el";"string"==typeof e&&(l=e);let[n,o]=e,r=null,a=!1;return o.context?(o.context.virtualCollection.forEach(t=>{if(!t.Fn&&t.identifier===l){a=!0;let e=[];t.controller.global.forEach(t=>{e.push(t.value)});let n=[];t.controller.local.forEach(t=>{n.push(t.value)});let i=t.component.render({global:e,local:n},o.props);t.props=o.props,i?i.length&&(i=i[0]):i=MC_Component.createEmptyElement(),t.HTMLElement=i,r=t.HTMLElement}}),a)?r:"nt%Rnd#el":(MC.anonimCollection.forEach(t=>{if(!t.Fn&&t.identifier===l){a=!0;let e=[];t.controller.global.forEach(t=>{e.push(t.value)});let n=[];t.controller.local.forEach(t=>{n.push(t.value)});let i=t.component.render({global:e,local:n},o.props);t.props=o.props,i=i?i[0]:MC_Component.createEmptyElement(),t.HTMLElement=i,r=t.HTMLElement}}),a)?r:"nt%Rnd#el"}registrController(t){this.state=t;let e={value:t.id},l=this.handlerRender(e,this.render,"");t.getPassport(l)}}class MC_Component{constructor(t){return this.getComponent(t)}static createEmptyElement(){let t=document.createElement("micro_component");return t.setAttribute("style","height: 0; width: 0; display: none;"),t.setAttribute("mc",!0),t}getComponent(t){return t}}class MC_Component_Registration{constructor(t){let[e,l,n]=t;"string"==typeof l&&(n=l,l=null);let o=l;return l||(o=[null,{context:null,props:null,states:null},]),MC.keys.push(n),this.register(e,o,n)}register(t,e,l){let[n,o]=e;if(o.context){let r=new t(o.props,o.context),a=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===r&&a.push(t)});let i=MC.uuidv4(),[c,s]=o.context.createVirtual_Component(r,i,l),u=[];o.states&&o.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),u.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let p=[];a&&a.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),p.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),s.props=o.props;let C=r.render({global:u,local:p},o.props,o.props);if(!C){let m=MC_Component.createEmptyElement();return s.controller={global:o.states,local:a},s.HTMLElement=m,m}let M=o.states?o.states:[],d=a||[];return C.length?(C[0].setAttribute("mc",!0),s.controller={global:M,local:d},s.HTMLElement=C[0],C[0]):(C.setAttribute("mc",!0),s.controller={global:M,local:d},s.HTMLElement=C,C)}{let h=new t(o.props,o.context),E=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===h&&E.push(t)});let g=MC.uuidv4(),[$,f]=MC.createAnonimComponent(h,g,l),v=[];o.states&&o.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add($),v.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let y=[];E&&E.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add($),y.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),f.props=o.props;let b=h.render({global:v,local:y},o.props,o.props);if(!b){let L=MC_Component.createEmptyElement();return f.controller={global:o.states,local:E},f.HTMLElement=L,L}let x=o.states?o.states:[],H=E||[];return b.length?(b[0].setAttribute("mc",!0),f.controller={global:x,local:H},f.HTMLElement=b[0],b[0]):(b.setAttribute("mc",!0),f.controller={global:x,local:H},f.HTMLElement=b,b)}}}class MC{static keys=[];static mc_state_global=new Set;static mc_context_global=new Set;constructor(){if(MC._instance)return MC._instance}static init(){var t=window.$;window.$.MC=function(){if(arguments[0].prototype instanceof MC){if(MCEngine.active){let e=MCEngine.renderChilds_Component(...arguments);if("nt%Rnd#el"!==e)return e}return new MC_Component(new MC_Component_Registration(arguments))}let[l,n,o]=arguments;if("function"==typeof l){if(MCEngine.active){let r=MCEngine.renderChilds_FC(o,l);if("nt%Rnd#el"!==r)return r}if(o){let a=MC.uuidv4(),[i,c]=o.createVirtual_FC(l,a),s=[];n&&n.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(i),s.push(t.value)):console.warn("Не стейт")});let u=l(s);if(!u){let p=MC_Component.createEmptyElement();return c.controller=n,c.HTMLElement=p,p}return u.length?(u[0].setAttribute("mc",!0),c.controller=n,c.HTMLElement=u[0],u[0]):(u.setAttribute("mc",!0),c.controller={global:global_st,local:local_st},c.HTMLElement=u,u)}{let C=l,m=n,M=MC.uuidv4(),[d,h]=MC.createAnonim_FC(C,M),E=[];m&&m.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(d),E.push(t.value)):console.warn("Не стейт")});let g=C(E);if(!g){let $=MC_Component.createEmptyElement();return h.controller=m,h.HTMLElement=$,$}return g.length?(g[0].setAttribute("mc",!0),h.controller=m,h.HTMLElement=g[0],g[0]):(g.setAttribute("mc",!0),h.controller=m,h.HTMLElement=g,g)}}let f=t.apply(this,arguments);return f}}static anonimCollection=new Set;static createAnonim_FC(t,e){let l={Fn:t,parent_id:null,key:e};return MC.anonimCollection.add(l),[{context:null,id_element:e},l]}static createAnonimComponent(t,e,l){let n={component:t,parent_id:null,key:e,identifier:l};return MC.anonimCollection.add(n),[{context:null,id_element:e},n]}state(t,e){return MC.createLocallyState(t,e,this)}static Props(t){let e=[],l={props:null,context:null,states:[]};for(let n in t){if(!Array.isArray(t[n])&&t[n]instanceof MCcontext){e[2]={context:t[n]},l.context=t[n];continue}if(Array.isArray(t[n])&&t[n].every(t=>t instanceof MCState)){e[1]={states:t[n]},l.states=t[n];continue}e[0]={props:t[n]},l.props=t[n]}return[e,l]}static uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}static createState(t,e){let l={value:t,key:e,id:MC.uuidv4()},n=new MCState(l);return new MCEngine().registrController(n),MC.mc_state_global.add(n),n}static createLocallyState(t,e,l){let n={value:t,id:MC.uuidv4(),key:e},o=new MCState(n,l);return new MCEngine().registrController(o),MC.mc_state_global.add(o),o}static createContext(t){let e={id:MC.uuidv4(),key:t},l=new MCcontext(e);return MC.mc_context_global.add(l),l}newKey(t){if(!t)return MC.uuidv4();{let e=[];for(let l=0;l<t;l++)e.push(MC.uuidv4());return e}}static getState(t){let e=[];return MC.mc_state_global.forEach(l=>{l.key===t&&e.push(l)}),e}static getContext(){let t;return MC.mc_context_global.forEach(e=>{e.id===id&&(t=e)}),t}}